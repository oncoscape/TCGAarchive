# Roadmap to Oncoscape API testing folder. The testing occurs at three different levels: 

- Datasource Structure-Level Testing
- Tool Qualification
- Tool Usefulness Evaluation for Given Organ Site

## Datasource Structure-Level Testing

#### *mongooseTest.js*

This is the code to generate ajv.json, the stage I datasource schema validation

- Requires: mongoose
  - collection_counts.json generated by *generate_collections_counts.js*
  - schemas.json
- Testing Purpose:
  - document-level data structure (ie. nested format is array or json object, and their sub-element structure)
  - data type (example types includes "string", "number", "boolean", and "null")
  - value pattern and property pattern (related fields includes sample IDs, css color codes, and etc)
  - necessary number ranges testing
  - required fields
  - multiple types validation (ie. schemas.pcaScores syntax is "oneOf")
  - Detail please refer to test/schemas.json. The current version includes all the types extracted from pancan12 and tcga manifest collections.
- Major procedures utilized:
  - substratify the entire collections to dataType collections
  - Use schema[type] against each document in each colleciton and collect all the possible errors. 

*Here is an example of schema for pcaScores collections:*

```
"pcaScores":{
        "properties":{
            "disease": {"type": "string"},
            "source": {"type": "string"},
            "type" : {"type": "string"},
            "geneset" : {"type": "string"},
            "scale": {"type": ["number", "null"]},
            "pc1" : {"type": "number"},
            "pc2" : {"type": "number"},
            "pc3" : {"type": "number"},
            "data":{
                    "type": "object", 
                    "patternProperties":{
                            "TCGA-[A-Z0-9]{2}-[A-Z0-9]{4}-[0-9]{2}": { "oneOf":[
                                                                  { 
                                                                    "type": "array",
                                                                    "maxitem": 3,
                                                                    "items": {"type": "number"}
                                                                   },
                                                                   {
                                                                      "type": "object",
                                                                      "properties":{
                                                                        "x": {"type": "number"},
                                                                        "y": {"type": "number"},
                                                                        "z": {"type": "number"}
                                                                      },
                                                                      "required": ["x", "y", "z"]
                                                                    }]
                                                              } 
                                        }
                    }
           }, 
          "required": ["type", "disease", "source", "scale", "data"],
          "additionalProperties": true  
          }
```    
    
*For a single document, the errors are in the array format, below is an example: only 'dataPath' and 'message' are being extracted during second process by mongooseTest2.js*
    
```
{
    "errorType": [
        {
            "keyword": "type",
            "dataPath": ".diagnosis_year",
            "schemaPath": "#/properties/diagnosis_year/type",
            "params": {
                "type": "number"
            },
            "message": "should be number"
        },
        {
            "keyword": "type",
            "dataPath": ".histologic_diagnosis",
            "schemaPath": "#/properties/histologic_diagnosis/type",
            "params": {
                "type": "string"
            },
            "message": "should be string"
        }
    ]
}

```

#### *mongooseTest2.js*

This is the script to generate ajv_tcga_v2_10182016.json, the stage II datasource schema validation

- Requires: ajv_tcga_10182016.json generated by mongooseTest.js
- Major procedures utilized:
  - re-organize the error messages 
  - calculate the passed percentage at collection level

*For each collection, there is a single object to report the data structural-level quality:*

```
{
        "collection": "luad_patient_tcga_clinical",
        "type": "patient",
        "disease": "luad",
        "passedCounts": 1006,
        "totalCounts": 1044,
        "passedRate": 0.9636015325670498,
        "errorMessage": {
            "#/properties/age_at_initial_pathologic_diagnosis/type [message: should be number]; Number of Violation: ": 38,
            "#/properties/days_to_diagnosis/type [message: should be number]; Number of Violation: ": 38,
            "#/properties/diagnosis_year/type [message: should be number]; Number of Violation: ": 20
        }
    }
```

## Tool Qualification

firstly check if the required collection(s) exists for tool usage

#### *disease_collection_structure_validation.js*

- Requires:
  - mongoose
  - diseaseCollectionSchema.json
  - ajv_tcga_v2_10182016.json generated by mongooseTest2.js
  - moduleTesting/test_toolname.js
- Testing Purposes
  - From lookup_oncoscape_datasources collection, using 'brain' as standard to generate diseaseCollectionSchema.json manually to describe the collection existence. Then use this schema to validate other disease type.
  - Create subfolder for modulated tests for each tool. This test suite mainly use the ajv_tcga_v2_10182016.json object.
  - The next step would be including the patient ID testing result to enrich the tool validation

*Here shows the collection schema describing the brain dataset from observation:*

```
var diseaseCollectionSchema = {
    "properties": {
        "disease": {"type": "string"}, 
        "source" : {"type": "string", "default": "TCGA"}, 
        "beta" : {"type": ["boolean", "string"]}, 
        "img" : {"type": "string"}, 
        "category": {"type": "array", 
                     "items": {"type": "object", 
                               "properties": {
                                  "source": {"type": "string"}, 
                                  "type": {"type": "string"}, 
                                  "collection": {"type": "string"}
                               },
                                "required": ["source", "type", "collection"]
                             }
                    },
        "molecular": {"type": "array", 
                     "items": {"type": "object", 
                               "properties": {
                                  "source": {"type": "string"}, 
                                  "type": {"type": "string"}, 
                                  "collection": {"type": "string"}
                               },
                                "required": ["source", "type", "collection"]
                             }
                    },
        "calculated": {"type": "array", 
                     "items": {"type": "object", 
                               "properties": {
                                  "source": {"type": "string"}, 
                                  "type": {"type": "string"}, 
                                  "collection": {"type": "string"}
                                },
                                "required": ["source", "type", "collection"]
                             }
                    },
        "clinical": {
                    "properties":{
                       "events": {"type": "string"},
                       "patient": {"type": "string"},
                       "drug": {"type": "string"},
                       "radiation": {"type": "string"},
                       "newTumor": {"type": "string"},
                       "otherMalignancy": {"type": "string"} 
                    },
                    "required": ["events", "patient", "drug", "radiation", "newTumor", "otherMalignancy"],
                    "additionalProperties": true
                    },
         "edges": {"type": "array", 
                     "items": {"type": "object", 
                               "properties": {
                                  "name": {"type": "string"}, 
                                  "source": {"type": "string"}, 
                                  "edges": {"type": "string"},
                                  "patientWeights": {"type": "string"},
                                  "genesWeights": {"type": "string"}
                               },
                                "required": ["name", "source", "edges", "patientWeights", "genesWeights"]
                             }
                    }                                    

    }
    ,
    "required": ["_id", "source", "beta", "name", "molecular", "calculated",  "clinical", "edges"], 
    "additionalProperties": true

};
```


# Running Procedures:

## Data Structural Testing Pipeline:

cd test/datasourceTesting

- node generate_manifestArr.js //*save manifest array as a json object* time: instantly
- node mongooseTest.js //*save ajvMsg_[date].json as a json object* time: 6379529ms = 106min
- node mongooseTest2.js //*save ajvMsg_v2_[date].json as a json object* time: instantly

## Pateint IDs Testing Pipeline:

cd test/patientIDTesting

- node PtIDCollecting.js //*save as output.json* 
- node PtIDProcess.js > output2.json //this is to test against clinical patient IDs *save as output2.json*
- node PtIDProcess2.js //*sort and save as IDErrors_briefv2.json*


## Gene Symbols Testing Pipeline:

So far, this pipeline is running on top of ajvMsg from datasourceTesting pipeline. It could run separately using manifest_arr.json.

cd test/geneSymbols

- node geneSymbols_checking.js //*output to json-like file as output.json* time: 466644ms
- node geneSymbols_resultProcess.js > output2.json //*output to json-like file as output2.json* time: instantly
- note geneSymbols_resultProcess2.js //*geneIDstatus_errors_brief.json* time: 6min

## Miscellaneous

cd test/report

#### Existing Collections against Manifest as well as lookup_oncoscape_datasources

#### render_pca & render_patient

#### clinical fields duplication status
- node checkingClinicalFields.js //*duplicatedFields.json

## Tools

#### required collections

cd test/toolTesting
- node interactive mode *disease_collection_structure_validation.js* // *output saved as diseaseCollectionStructuralStatus.json & report_arr.json*
- tool_test.js // reconstruct lookup table to include tool slot
  1. Timeline is determined if the events table exists in the clinical
  2. 






