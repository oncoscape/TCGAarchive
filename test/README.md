# Roadmap to Oncoscape API testing folder. The testing occurs at three different levels: 

- Datasource Structure-Level Testing
- Tool Qualification
- Tool Usefulness Evaluation for Given Organ Site

## Datasource Structure-Level Testing

#### **mongooseTest.js**

This is the code to generate ajv.json, the stage I datasource schema validation

- Requires: mongoose
  - collection_counts.json generated by *generate_collections_counts.js*
  - schemas.json
- Testing Purpose:
  - document-level data structure (ie. nested format is array or json object, and their sub-element structure)
  - data type (example types includes "string", "number", "boolean", and "null")
  - value pattern and property pattern (related fields includes sample IDs, css color codes, and etc)
  - necessary number ranges testing
  - required fields
  - multiple types validation (ie. schemas.pcaScores syntax is "oneOf")
  - Detail please refer to test/schemas.json. The current version includes all the types extracted from pancan12 and tcga manifest collections.
- Major procedures utilized:
  - substratify the entire collections to dataType collections
  - Use schema[type] against each document in each colleciton and collect all the possible errors. 

**Here is an example of schema for pcaScores collections:**

```
"pcaScores":{
        "properties":{
            "disease": {"type": "string"},
            "source": {"type": "string"},
            "type" : {"type": "string"},
            "geneset" : {"type": "string"},
            "scale": {"type": ["number", "null"]},
            "pc1" : {"type": "number"},
            "pc2" : {"type": "number"},
            "pc3" : {"type": "number"},
            "data":{
                    "type": "object", 
                    "patternProperties":{
                            "TCGA-[A-Z0-9]{2}-[A-Z0-9]{4}-[0-9]{2}": { "oneOf":[
                                                                  { 
                                                                    "type": "array",
                                                                    "maxitem": 3,
                                                                    "items": {"type": "number"}
                                                                   },
                                                                   {
                                                                      "type": "object",
                                                                      "properties":{
                                                                        "x": {"type": "number"},
                                                                        "y": {"type": "number"},
                                                                        "z": {"type": "number"}
                                                                      },
                                                                      "required": ["x", "y", "z"]
                                                                    }]
                                                              } 
                                        }
                    }
           }, 
          "required": ["type", "disease", "source", "scale", "data"],
          "additionalProperties": true  
          }
```    
    
**For a single document, the errors are in the array format, below is an example: only 'dataPath' and 'message' are being extracted during second process by mongooseTest2.js**
    
```
{
    "errorType": [
        {
            "keyword": "type",
            "dataPath": ".diagnosis_year",
            "schemaPath": "#/properties/diagnosis_year/type",
            "params": {
                "type": "number"
            },
            "message": "should be number"
        },
        {
            "keyword": "type",
            "dataPath": ".histologic_diagnosis",
            "schemaPath": "#/properties/histologic_diagnosis/type",
            "params": {
                "type": "string"
            },
            "message": "should be string"
        }
    ]
}

```

#### **mongooseTest2.js**

This is the script to generate ajv_tcga_v2_10182016.json, the stage II datasource schema validation

- Requires: ajv_tcga_10182016.json generated by mongooseTest.js
- Major procedures utilized:
  - re-organize the error messages 
  - calculate the passed percentage at collection level

**For each collection, there is a single object to report the data structural-level quality:**

```
{
        "collection": "luad_patient_tcga_clinical",
        "type": "patient",
        "disease": "luad",
        "passedCounts": 1006,
        "totalCounts": 1044,
        "passedRate": 0.9636015325670498,
        "errorMessage": {
            "#/properties/age_at_initial_pathologic_diagnosis/type [message: should be number]; Number of Violation: ": 38,
            "#/properties/days_to_diagnosis/type [message: should be number]; Number of Violation: ": 38,
            "#/properties/diagnosis_year/type [message: should be number]; Number of Violation: ": 20
        }
    }
```

## Tool Qualification

firstly check if the required collection(s) exists for tool usage

#### **disease_collection_structure_validation.js**

- Requires:
  - mongoose
  - diseaseCollectionSchema.json
  - ajv_tcga_v2_10182016.json generated by mongooseTest2.js
  - moduleTesting/test_toolname.js
- Testing Purposes
  - From lookup_oncoscape_datasources collection, using 'brain' as standard to generate diseaseCollectionSchema.json manually to describe the collection existence. Then use this schema to validate other disease type.
  - Create subfolder for modulated tests for each tool. This test suite mainly use the ajv_tcga_v2_10182016.json object.
  - The next step would be including the patient ID testing result to enrich the tool validation

**Here shows the collection schema describing the brain dataset from observation:**

```
var diseaseCollectionSchema = {
    "properties": {
        "disease": {"type": "string"}, 
        "source" : {"type": "string", "default": "TCGA"}, 
        "beta" : {"type": ["boolean", "string"]}, 
        "img" : {"type": "string"}, 
        "category": {"type": "array", 
                     "items": {"type": "object", 
                               "properties": {
                                  "source": {"type": "string"}, 
                                  "type": {"type": "string"}, 
                                  "collection": {"type": "string"}
                               },
                                "required": ["source", "type", "collection"]
                             }
                    },
        "molecular": {"type": "array", 
                     "items": {"type": "object", 
                               "properties": {
                                  "source": {"type": "string"}, 
                                  "type": {"type": "string"}, 
                                  "collection": {"type": "string"}
                               },
                                "required": ["source", "type", "collection"]
                             }
                    },
        "calculated": {"type": "array", 
                     "items": {"type": "object", 
                               "properties": {
                                  "source": {"type": "string"}, 
                                  "type": {"type": "string"}, 
                                  "collection": {"type": "string"}
                                },
                                "required": ["source", "type", "collection"]
                             }
                    },
        "clinical": {
                    "properties":{
                       "events": {"type": "string"},
                       "patient": {"type": "string"},
                       "drug": {"type": "string"},
                       "radiation": {"type": "string"},
                       "newTumor": {"type": "string"},
                       "otherMalignancy": {"type": "string"} 
                    },
                    "required": ["events", "patient", "drug", "radiation", "newTumor", "otherMalignancy"],
                    "additionalProperties": true
                    },
         "edges": {"type": "array", 
                     "items": {"type": "object", 
                               "properties": {
                                  "name": {"type": "string"}, 
                                  "source": {"type": "string"}, 
                                  "edges": {"type": "string"},
                                  "patientWeights": {"type": "string"},
                                  "genesWeights": {"type": "string"}
                               },
                                "required": ["name", "source", "edges", "patientWeights", "genesWeights"]
                             }
                    }                                    

    }
    ,
    "required": ["_id", "source", "beta", "name", "molecular", "calculated",  "clinical", "edges"], 
    "additionalProperties": true

};
```

# Upon Database Update

### If manifest is updated...

- [ ] If 'dataType' is updated, schemas.json needs to be revised accordingly.
- [ ] Manifest is important to track each colleciton's type for data-structure validation and patient ID checking.
- [ ] Re-run **datasourceTesting/generate_collections_counts.js** to fill the total count for each collection, runs quickly (less then 3 min). This script generate useful information to do the passedRate calculation for each collection
- [ ] Re-run **datasourceTesting/mongooseTest.js** runs slow (~1.5hrs)
- [ ] check the update on manifest.collection names, only run **datasourceTesting/generate_collections_counts.js** on new added; and only run **datasourceTesting/mongooseTest.js** to the new added

### If lookup_oncoscape_datasources is updated...

- [ ] If the basic collection structure is updated, diseaseCollectionSchema json object in **toolTesting/disease_colleciton_structure_validation.js** 








### Patient ID testing

 - forPatientIDChecking/CheckPatientIDs.js
 - output includes all the collections except for molecular type, cnv, mut, mut01, rna, protein and methylation types in seperate json documents in /report


# Running Procedure
### Step I:
- node generate_collections_counts.js //output will be in the test folder as "collection_counts.json"

### Step II:
- in interactive node mode, run mongooseTest.js
- save ajvMsg as a json object

### Step III:
- in interactive node mode, run mongooseTest2.js
- save ajvMsg_v2 as a json object

### Daily Database Sanitory Checking

Direct to the current database subfolder and run **generateDailyReport.js** 
The output is a markdown file stored in report subfolder under the current directory

```sh
report/log_10182016.md
date > report/log_1018016.md
node generateDailyReport.js >> report/log_10182016.md 
```





