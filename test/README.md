# Roadmap to Oncoscape API testing folder. The testing occurs at three different levels: 

- Datasource Structure-Level Testing
- Tool Qualification
- Tool Usefulness Evaluation for Given Organ Site

## Datasource Structure-Level Testing

#### **mongooseTest.js**

This is the code to generate ajv.json, the stage I datasource schema validation

- Requires: mongoose
  - collection_counts.json generated by *generate_collections_counts.js*
  - schemas.json
- Testing Purpose:
  - document-level data structure (ie. nested format is array or json object, and their sub-element structure)
  - data type (example types includes "string", "number", "boolean", and "null")
  - value pattern and property pattern (related fields includes sample IDs, css color codes, and etc)
  - necessary number ranges testing
  - required fields
  - multiple types validation (ie. schemas.pcaScores syntax is "oneOf")
  - Detail please refer to test/schemas.json. The current version includes all the types extracted from pancan12 and tcga manifest collections.
- Major procedures utilized:
  - substratify the entire collections to dataType collections
  - Use schema[type] against each document in each colleciton and collect all the possible errors. 

**Here is an example of schema for pcaScores collections:**
```
"pcaScores":{
        "properties":{
            "disease": {"type": "string"},
            "source": {"type": "string"},
            "type" : {"type": "string"},
            "geneset" : {"type": "string"},
            "scale": {"type": ["number", "null"]},
            "pc1" : {"type": "number"},
            "pc2" : {"type": "number"},
            "pc3" : {"type": "number"},
            "data":{
                    "type": "object", 
                    "patternProperties":{
                            "TCGA-[A-Z0-9]{2}-[A-Z0-9]{4}-[0-9]{2}": { "oneOf":[
                                                                  { 
                                                                    "type": "array",
                                                                    "maxitem": 3,
                                                                    "items": {"type": "number"}
                                                                   },
                                                                   {
                                                                      "type": "object",
                                                                      "properties":{
                                                                        "x": {"type": "number"},
                                                                        "y": {"type": "number"},
                                                                        "z": {"type": "number"}
                                                                      },
                                                                      "required": ["x", "y", "z"]
                                                                    }]
                                                              } 
                                        }
                    }
           }, 
          "required": ["type", "disease", "source", "scale", "data"],
          "additionalProperties": true  
          }
```    
    
**For a single document, the errors are in the array format, below is an example:**
    
```
{
    "errorType": [
        {
            "keyword": "type",
            "dataPath": ".diagnosis_year",
            "schemaPath": "#/properties/diagnosis_year/type",
            "params": {
                "type": "number"
            },
            "message": "should be number"
        },
        {
            "keyword": "type",
            "dataPath": ".histologic_diagnosis",
            "schemaPath": "#/properties/histologic_diagnosis/type",
            "params": {
                "type": "string"
            },
            "message": "should be string"
        }
    ]
}

```

#### **mongooseTest2.js**

This is the script to generate ajv_tcga_v2_10182016.json, the stage II datasource schema validation

- Requires: ajv_tcga_10182016.json generated by mongooseTest.js
- Major procedures utilized:
  - re-organize the error messages 
  - calculate the passed percentage at collection level


## Tool Qualification

firstly check if the required collection(s) exists for tool usage

#### **disease_collection_structure_validation.js**

This is the code to generate report_arr.json, using brain as standard

- requires: mongoose
      - ajv_v2.json generated by mongooseTest2.js
      - moduleTesting/test_toolname.js
- Purposes
      - validate the tool accessible according to the collection existence
      - incorperate the datasource quality data into tool validation

### Patient ID testing

 - forPatientIDChecking/CheckPatientIDs.js
 - output includes all the collections except for molecular type, cnv, mut, mut01, rna, protein and methylation types in seperate json documents in /report







# Running Procedure
### Step I:
- node generate_collections_counts.js //output will be in the test folder as "collection_counts.json"

### Step II:
- in interactive node mode, run mongooseTest.js
- save ajvMsg as a json object

### Step III:
- in interactive node mode, run mongooseTest2.js
- save ajvMsg_v2 as a json object

### Daily Database Sanitory Checking

Direct to the current database subfolder and run **generateDailyReport.js** 
The output is a markdown file stored in report subfolder under the current directory

```sh
report/log_10182016.md
date > report/log_1018016.md
node generateDailyReport.js >> report/log_10182016.md 
```
